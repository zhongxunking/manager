<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>配置中心-管理员</title>
    <script src="../import.js"></script>
</head>
<body>
<div id="managersApp">
    <el-row>
        <el-col>
            <el-form :v-model="queryManagersForm" :inline="true" size="small">
                <el-form-item>
                    <el-input v-model="queryManagersForm.managerId" clearable placeholder="管理员id"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-input v-model="queryManagersForm.name" clearable placeholder="名称"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-select v-model="queryManagersForm.type" clearable placeholder="类型">
                        <el-option value="NORMAL" label="普通管理员"></el-option>
                        <el-option value="ADMIN" label="超级管理员"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" icon="el-icon-search" @click="queryManagers">查询</el-button>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" icon="el-icon-plus" @click="addManagerDialogVisible = true">新增</el-button>
                </el-form-item>
            </el-form>
        </el-col>
    </el-row>
    <el-table :data="managers" v-loading="managersLoading" border stripe>
        <el-table-column prop="managerId" label="管理员id"></el-table-column>
        <el-table-column prop="name" label="名称">
            <template slot-scope="{ row }">
                <span v-if="!row.editing">{{ row.name }}</span>
                <el-input v-else v-model="row.editingName" size="small" clearable placeholder="请输入名称"></el-input>
            </template>
        </el-table-column>
        <el-table-column prop="type" label="类型">
            <template slot-scope="{ row }">
                <span v-if="!row.editing">
                    <el-tag v-if="row.type === 'NORMAL'" type="success">普通管理员</el-tag>
                    <el-tag v-else-if="row.type === 'ADMIN'" type="warning">超级管理员</el-tag>
                </span>
                <el-select v-else v-model="row.editingType" size="small" placeholder="请选择类型">
                    <el-option value="NORMAL" label="普通管理员"></el-option>
                    <el-option value="ADMIN" label="超级管理员"></el-option>
                </el-select>
            </template>
        </el-table-column>
        <el-table-column prop="secretKey" label="密钥" width="400px">
            <template slot-scope="{ row }">
                <template v-if="row.secretKey">
                    <el-row>
                        <el-col :span="18">
                            <span v-if="row.showingSecretKey">{{ row.secretKey }}</span>
                            <span v-else>********************************</span>
                        </el-col>
                        <el-col :span="6">
                            <el-tooltip content="显示/隐藏" placement="top" :open-delay="1000" :hide-after="3000">
                                <el-button @click="row.showingSecretKey = !row.showingSecretKey" type="success" icon="el-icon-view" size="mini" circle style="margin-left: 0"></el-button>
                            </el-tooltip>
                            <el-tooltip content="更换" placement="top" :open-delay="1000" :hide-after="3000">
                                <el-button @click="refreshSecretKey(row)" type="primary" icon="el-icon-refresh" size="mini" circle style="margin-left: 0"></el-button>
                            </el-tooltip>
                            <el-tooltip content="删除" placement="top" :open-delay="1000" :hide-after="3000">
                                <el-button @click="deleteSecretKey(row)" type="danger" icon="el-icon-delete" size="mini" circle style="margin-left: 0"></el-button>
                            </el-tooltip>
                        </el-col>
                    </el-row>
                </template>
                <template v-else>
                    <el-row>
                        <el-col :span="18">
                            <el-tag type="success">无</el-tag>
                        </el-col>
                        <el-col :span="6">
                            <el-tooltip content="创建" placement="top" :open-delay="1000" :hide-after="3000">
                                <el-button @click="setNewSecretKey(row)" type="success" icon="el-icon-plus" size="mini" circle style="margin-left: 0"></el-button>
                            </el-tooltip>
                        </el-col>
                    </el-row>
                </template>
            </template>
        </el-table-column>
        <el-table-column label="操作" header-align="center" width="200px">
            <template slot-scope="{ row }">
                <el-row>
                    <el-col :span="9" style="text-align: center">
                        <el-tooltip v-if="!row.editing" content="修改" placement="top" :open-delay="1000" :hide-after="3000">
                            <el-button @click="startEditing(row)" type="primary" icon="el-icon-edit" size="small" circle></el-button>
                        </el-tooltip>
                        <template v-else>
                            <el-button-group>
                                <el-tooltip content="取消修改" placement="top" :open-delay="1000" :hide-after="3000">
                                    <el-button @click="row.editing = false" type="info" icon="el-icon-close" size="small" circle></el-button>
                                </el-tooltip>
                                <el-popover placement="top" v-model="row.savePopoverShowing">
                                    <p>确定保存修改？</p>
                                    <div style="text-align: right; margin: 0">
                                        <el-button size="mini" type="text" @click="row.savePopoverShowing = false">取消</el-button>
                                        <el-button type="primary" size="mini" @click="saveEditing(row)">确定</el-button>
                                    </div>
                                    <el-tooltip slot="reference" :disabled="row.savePopoverShowing" content="保存修改" placement="top" :open-delay="1000" :hide-after="3000">
                                        <el-button @click="row.savePopoverShowing = true" type="success" icon="el-icon-check" size="small" circle></el-button>
                                    </el-tooltip>
                                </el-popover>
                            </el-button-group>
                        </template>
                    </el-col>
                    <el-col :span="9" style="text-align: center">
                        <el-tooltip content="修改密码" placement="top" :open-delay="1000" :hide-after="3000">
                            <el-button @click="startModifyManagerPassword(row)" type="primary" icon="el-icon-edit" size="small" round>P</el-button>
                        </el-tooltip>
                    </el-col>
                    <el-col :span="6" style="text-align: center">
                        <el-tooltip content="删除" placement="top" :open-delay="1000" :hide-after="3000">
                            <el-button @click="deleteManager(row)" type="danger" icon="el-icon-delete" size="small" circle></el-button>
                        </el-tooltip>
                    </el-col>
                </el-row>
            </template>
        </el-table-column>
    </el-table>
    <el-row style="margin-top: 10px">
        <el-col style="text-align: end">
            <el-pagination :total="totalManagers" :current-page.sync="queryManagersForm.pageNo" :page-size.sync="queryManagersForm.pageSize" @current-change="queryManagers" layout="total,prev,pager,next" small background></el-pagination>
        </el-col>
    </el-row>
    <el-dialog :visible.sync="addManagerDialogVisible" :before-close="closeAddManagerDialog" title="新增管理员" width="40%">
        <el-form ref="addManagerForm" :model="addManagerForm" label-width="30%">
            <el-form-item label="管理员id" prop="managerId" :rules="[{required:true, message:'请输入管理员id', trigger:'blur'}]">
                <el-input v-model="addManagerForm.managerId" clearable placeholder="请输入管理员id" style="width: 90%"></el-input>
            </el-form-item>
            <el-form-item label="名称" prop="name" :rules="[{required:true, message:'请输入名称', trigger:'blur'}]">
                <el-input v-model="addManagerForm.name" clearable placeholder="请输入名称" style="width: 90%"></el-input>
            </el-form-item>
            <el-form-item label="类型" prop="type" :rules="[{required:true, message:'请选择类型', trigger:'blur'}]">
                <el-select v-model="addManagerForm.type" clearable placeholder="请选择类型" style="width: 90%">
                    <el-option value="NORMAL" label="普通管理员"></el-option>
                    <el-option value="ADMIN" label="超级管理员"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="初始密码" prop="password" :rules="[{required:true, message:'请输入初始密码', trigger:'blur'}]">
                <el-input v-model="addManagerForm.password" type="password" clearable placeholder="请输入初始密码" style="width: 90%"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="closeAddManagerDialog">取消</el-button>
            <el-button type="primary" @click="addManager">提交</el-button>
        </div>
    </el-dialog>
    <el-dialog :visible.sync="modifyManagerPasswordDialogVisible" :before-close="closeModifyManagerPasswordDialog" title="修改管理员密码" width="40%">
        <el-form ref="modifyManagerPasswordForm" :model="modifyManagerPasswordForm" label-width="30%">
            <el-form-item label="管理员：" prop="manager">
                <span>{{ toShowingManager(modifyManagerPasswordForm.manager) }}</span>
            </el-form-item>
            <el-form-item label="新密码：" prop="newPassword" :rules="[{required:true, message:'请输入新密码', trigger:'blur'}]">
                <el-input v-model="modifyManagerPasswordForm.newPassword" type="password" clearable placeholder="请输入新密码" style="width: 90%"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="closeModifyManagerPasswordDialog">取消</el-button>
            <el-button type="primary" @click="modifyManagerPassword">提交</el-button>
        </div>
    </el-dialog>
</div>
<script>
    const managersApp = new Vue({
        el: '#managersApp',
        data: {
            queryManagersForm: {
                pageNo: 1,
                pageSize: 10,
                managerId: null,
                type: null,
                name: null
            },
            managersLoading: false,
            totalManagers: 0,
            managers: [],
            addManagerDialogVisible: false,
            addManagerForm: {
                managerId: null,
                type: null,
                name: null,
                password: null
            },
            modifyManagerPasswordDialogVisible: false,
            modifyManagerPasswordForm: {
                manager: null,
                newPassword: null
            }
        },
        created: function () {
            this.queryManagers();
        },
        methods: {
            queryManagers: function () {
                this.managersLoading = true;
                const theThis = this;
                axios.get(MANAGER_ROOT_PATH + '/manager/manage/query', {params: this.queryManagersForm})
                    .then(function (result) {
                        theThis.managersLoading = false;
                        if (!result.success) {
                            Vue.prototype.$message.error(result.message);
                            return;
                        }
                        theThis.totalManagers = result.totalCount;
                        theThis.managers = result.infos;
                        theThis.managers.forEach(function (manager) {
                            Vue.set(manager, 'editing', false);
                            Vue.set(manager, 'editingType', null);
                            Vue.set(manager, 'editingName', null);
                            Vue.set(manager, 'showingSecretKey', false);
                            Vue.set(manager, 'savePopoverShowing', false);
                        });
                    });
            },
            startEditing: function (manager) {
                manager.editing = true;
                manager.editingType = manager.type;
                manager.editingName = manager.name;
            },
            saveEditing: function (manager) {
                manager.savePopoverShowing = false;

                const theThis = this;
                axios.post(MANAGER_ROOT_PATH + '/manager/manage/modifyType', {
                    managerId: manager.managerId,
                    newType: manager.editingType
                }).then(function (result) {
                    if (!result.success) {
                        Vue.prototype.$message.error(result.message);
                        return;
                    }
                    axios.post(MANAGER_ROOT_PATH + '/manager/manage/modifyName', {
                        managerId: manager.managerId,
                        newName: manager.editingName
                    }).then(function (result) {
                        if (result.success) {
                            Vue.prototype.$message.success(result.message);
                        } else {
                            Vue.prototype.$message.error(result.message);
                        }
                        theThis.queryManagers();
                    });
                });
            },
            deleteManager: function (manager) {
                const theThis = this;
                Vue.prototype.$confirm('确定删除管理员？', '警告', {type: 'warning'})
                    .then(function () {
                        axios.post(MANAGER_ROOT_PATH + '/manager/manage/delete', {managerId: manager.managerId})
                            .then(function (result) {
                                if (!result.success) {
                                    Vue.prototype.$message.error(result.message);
                                    return;
                                }
                                Vue.prototype.$message.success(result.message);
                                theThis.queryManagers();
                            });
                    });
            },
            addManager: function () {
                const theThis = this;
                this.$refs.addManagerForm.validate(function (valid) {
                    if (!valid) {
                        return;
                    }
                    axios.post(MANAGER_ROOT_PATH + '/manager/manage/add', theThis.addManagerForm)
                        .then(function (result) {
                            if (!result.success) {
                                Vue.prototype.$message.error(result.message);
                                return;
                            }
                            Vue.prototype.$message.success(result.message);
                            theThis.closeAddManagerDialog();
                            theThis.queryManagers();
                        });
                })
            },
            closeAddManagerDialog: function () {
                this.addManagerDialogVisible = false;
                this.addManagerForm.managerId = null;
                this.addManagerForm.type = null;
                this.addManagerForm.name = null;
                this.addManagerForm.password = null;
            },
            startModifyManagerPassword: function (manager) {
                this.modifyManagerPasswordDialogVisible = true;
                this.modifyManagerPasswordForm.manager = manager;
            },
            modifyManagerPassword: function () {
                const theThis = this;
                axios.post(MANAGER_ROOT_PATH + '/manager/manage/modifyPassword', {
                    managerId: this.modifyManagerPasswordForm.manager.managerId,
                    newPassword: this.modifyManagerPasswordForm.newPassword
                }).then(function (result) {
                    if (!result.success) {
                        Vue.prototype.$message.error(result.message);
                        return;
                    }
                    Vue.prototype.$message.success(result.message);
                    theThis.closeModifyManagerPasswordDialog();
                });
            },
            closeModifyManagerPasswordDialog: function () {
                this.modifyManagerPasswordDialogVisible = false;
                this.modifyManagerPasswordForm.manager = null;
                this.modifyManagerPasswordForm.newPassword = null;
            },
            toShowingManager: function (manager) {
                if (!manager) {
                    return '';
                }
                let text = manager.managerId;
                if (manager.name) {
                    text += '（' + manager.name + '）';
                }
                return text;
            },
            refreshSecretKey: function (manager) {
                const theThis = this;
                Vue.prototype.$confirm('确定更换密钥？', '警告', {type: 'warning'})
                    .then(function () {
                        theThis.setNewSecretKey(manager);
                    });
            },
            setNewSecretKey: function (manager) {
                const theThis = this;
                axios.get(MANAGER_ROOT_PATH + '/manager/main/randomCode', {params: {}})
                    .then(function (result) {
                        if (!result.success) {
                            Vue.prototype.$message.error(result.message);
                            return;
                        }
                        theThis.modifySecretKey(manager.managerId, result.randomCode, function () {
                            manager.secretKey = result.randomCode;
                            manager.showingSecretKey = true;
                        });
                    });
            },
            deleteSecretKey: function (manager) {
                const theThis = this;
                Vue.prototype.$confirm('确定删除密钥？', '警告', {type: 'warning'})
                    .then(function () {
                        theThis.modifySecretKey(manager.managerId, null, function () {
                            manager.secretKey = null;
                        });
                    });
            },
            modifySecretKey: function (managerId, secretKey, callback) {
                axios.post(MANAGER_ROOT_PATH + '/manager/manage/modifySecretKey', {
                    managerId: managerId,
                    secretKey: secretKey
                }).then(function (result) {
                    if (!result.success) {
                        Vue.prototype.$message.error(result.message);
                        return;
                    }
                    Vue.prototype.$message.success(result.message);
                    callback();
                });
            }
        }
    });
</script>
</body>
</html>